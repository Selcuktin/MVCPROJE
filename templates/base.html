{% load static %}
{% load user_tags %}
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Kurs Y√∂netim Sistemi{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <!-- Modern Cards CSS -->
    <link rel="stylesheet" href="{% static 'css/modern-cards.css' %}">
    
    <!-- Botpress AI Chatbot - LEFT BOTTOM -->
    <!-- https://botpress.com/ -->
    
    {% if user.is_authenticated %}
    <!-- Botpress Widget Button -->
    <button id="botpress-chat-btn" title="AI Asistan">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- Botpress Widget Container -->
    <div id="botpress-chat-widget">
        <div id="botpress-chat-header">
            <span>ü§ñ √ñƒürenci ƒ∞≈üleri Asistanƒ±</span>
            <button id="botpress-chat-close">&times;</button>
        </div>
        <!-- iframe'e unique key ekleyerek her kullanƒ±cƒ± i√ßin yeni instance olu≈ütur -->
        <iframe 
            id="botpress-iframe"
            key="botpress-{{ user.id }}-{{ user.username }}"
            src=""
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
            style="width: 100%; height: calc(100% - 60px); border: none; border-radius: 0 0 15px 15px;"
        ></iframe>
    </div>
    
    <style>
        /* Botpress Button - Sol Alt */
        #botpress-chat-btn {
            position: fixed !important;
            left: 24px !important;
            bottom: 24px !important;
            z-index: 99997 !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: #fff !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            box-shadow: 0 4px 18px rgba(76, 175, 80, 0.4) !important;
            border: none !important;
            transition: all 0.3s ease !important;
        }
        
        #botpress-chat-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(76, 175, 80, 0.5) !important;
        }
        
        /* Botpress Widget - Sol Alt */
        #botpress-chat-widget {
            position: fixed !important;
            left: 24px !important;
            bottom: 90px !important;
            z-index: 99996 !important;
            width: 380px !important;
            height: 550px !important;
            background: white !important;
            border-radius: 15px !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
            display: none !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }
        
        #botpress-chat-widget.active {
            display: flex !important;
        }
        
        #botpress-chat-header {
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
            padding: 15px 20px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            border-radius: 15px 15px 0 0 !important;
        }
        
        #botpress-chat-close {
            background: none !important;
            border: none !important;
            color: white !important;
            font-size: 24px !important;
            cursor: pointer !important;
            line-height: 1 !important;
            transition: all 0.3s ease !important;
        }
        
        #botpress-chat-close:hover {
            transform: rotate(90deg);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            #botpress-chat-btn {
                left: 16px !important;
                bottom: 16px !important;
                width: 52px !important;
                height: 52px !important;
            }
            
            #botpress-chat-widget {
                left: 16px !important;
                bottom: 80px !important;
                width: calc(100vw - 32px) !important;
                height: 480px !important;
            }
        }
    </style>
    
    <script>
        (function() {
            // Kullanƒ±cƒ±ya √∂zel benzersiz session ID olu≈ütur
            const userId = '{{ user.id }}';
            const username = '{{ user.username }}';
            const userType = '{{ user.userprofile.user_type|default:"student" }}';
            const fullName = '{{ user.get_full_name|default:user.username }}';
            
            // HER LOGIN ƒ∞√áƒ∞N TAMAMEN BENZERSƒ∞Z userId
            // Login zamanƒ±nƒ± session'dan al, yoksa ≈üimdiyi kullan
            let loginTimestamp = sessionStorage.getItem('user_login_timestamp');
            if (!loginTimestamp) {
                loginTimestamp = new Date().getTime();
                sessionStorage.setItem('user_login_timestamp', loginTimestamp);
            }
            
            const randomStr = Math.random().toString(36).substring(2, 15);
            
            // BOTPRESS ƒ∞√áƒ∞N KULLANICI ID - Her login'de farklƒ±
            const botpressUserId = 'bp_user_' + userId + '_login_' + loginTimestamp + '_' + randomStr;
            
            // Bizim tracking i√ßin session ID
            const sessionId = 'user_' + userId + '_' + randomStr;
            
            // Conversation ID
            const conversationId = 'conv_' + userId + '_' + loginTimestamp + '_' + randomStr;
            
            console.log('=== BOTPRESS BA≈ûLATILIYOR ===');
            console.log('Kullanƒ±cƒ± ID:', userId);
            console.log('Kullanƒ±cƒ± Adƒ±:', fullName);
            console.log('Login Timestamp:', loginTimestamp);
            console.log('Botpress User ID:', botpressUserId);
            console.log('Session ID:', sessionId);
            console.log('Conversation ID:', conversationId);
            
            // √ñnceki kullanƒ±cƒ±yƒ± kontrol et
            const previousUserId = localStorage.getItem('botpress_current_user_id');
            const previousLoginTime = localStorage.getItem('botpress_login_timestamp');
            let isNewUser = previousUserId !== userId;
            let isNewLogin = previousLoginTime !== loginTimestamp;
            
            // Reload flag kontrol√º - sonsuz d√∂ng√ºy√º √∂nle
            const reloadFlag = sessionStorage.getItem('botpress_reload_done');
            
            if ((isNewUser || isNewLogin) && !reloadFlag) {
                console.log('üîÑ YENƒ∞ KULLANICI VEYA YENƒ∞ LOGIN TESPƒ∞T EDƒ∞LDƒ∞!');
                console.log('√ñnceki kullanƒ±cƒ±:', previousUserId);
                console.log('Yeni kullanƒ±cƒ±:', userId);
                console.log('√ñnceki login:', previousLoginTime);
                console.log('Yeni login:', loginTimestamp);
                
                // BOTPRESS'ƒ∞N KULLANDIƒûI T√úM STORAGE'I AGRESƒ∞F TEMƒ∞ZLE
                try {
                    // 1. LocalStorage - T√úM anahtarlarƒ± temizle
                    const allKeys = Object.keys(localStorage);
                    let cleanedCount = 0;
                    allKeys.forEach(key => {
                        // Botpress'in kullandƒ±ƒüƒ± t√ºm key pattern'leri
                        if (key.includes('botpress') || 
                            key.includes('bp-') || 
                            key.includes('bp_') ||
                            key.startsWith('bp') ||
                            key.includes('webchat') ||
                            key.includes('conversation') ||
                            key.includes('conv-') ||
                            key.includes('messaging') ||
                            key.includes('chat')) {
                            localStorage.removeItem(key);
                            cleanedCount++;
                            console.log('üóëÔ∏è Temizlendi:', key);
                        }
                    });
                    console.log('‚úÖ LocalStorage temizlendi:', cleanedCount, 'anahtar');
                    
                    // 2. SessionStorage - Botpress anahtarlarƒ±nƒ± temizle (login timestamp hari√ß)
                    const sessionKeys = Object.keys(sessionStorage);
                    sessionKeys.forEach(key => {
                        if (key !== 'user_login_timestamp' && 
                            (key.includes('botpress') || 
                            key.includes('bp-') || 
                            key.includes('bp_') ||
                            key.startsWith('bp') ||
                            key.includes('webchat') ||
                            key.includes('conversation') ||
                            key.includes('messaging') ||
                            key.includes('chat'))) {
                            sessionStorage.removeItem(key);
                            console.log('üóëÔ∏è SessionStorage temizlendi:', key);
                        }
                    });
                    
                    // 3. Cookies - Botpress cookie'lerini agresif temizle
                    const cookies = document.cookie.split(";");
                    cookies.forEach(function(c) {
                        const cookieName = c.split("=")[0].trim();
                        if (cookieName.includes('botpress') || 
                            cookieName.includes('bp-') || 
                            cookieName.includes('bp_') ||
                            cookieName.startsWith('bp') ||
                            cookieName.includes('webchat')) {
                            // Cookie'yi t√ºm path'ler ve domain'ler i√ßin sil
                            const domains = [
                                window.location.hostname,
                                '.' + window.location.hostname,
                                '.botpress.cloud',
                                '.bpcontent.cloud'
                            ];
                            const paths = ['/', '/webchat', '/chat'];
                            
                            domains.forEach(domain => {
                                paths.forEach(path => {
                                    document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=" + path + ";domain=" + domain;
                                });
                            });
                            console.log('üóëÔ∏è Cookie silindi:', cookieName);
                        }
                    });
                    console.log('‚úÖ Cookies temizlendi');
                    
                    // 4. IndexedDB - Botpress veritabanlarƒ±nƒ± sil
                    if (window.indexedDB && window.indexedDB.databases) {
                        indexedDB.databases().then(databases => {
                            databases.forEach(db => {
                                if (db.name && (db.name.includes('botpress') || 
                                               db.name.includes('bp-') || 
                                               db.name.includes('webchat'))) {
                                    indexedDB.deleteDatabase(db.name);
                                    console.log('üóëÔ∏è IndexedDB silindi:', db.name);
                                }
                            });
                        }).catch(e => console.log('IndexedDB temizlenemedi:', e));
                    }
                    
                    // Reload flag'i ayarla (sonsuz d√∂ng√ºy√º √∂nle)
                    sessionStorage.setItem('botpress_reload_done', 'true');
                    
                    console.log('üîÑ Sayfa yenileniyor (temizlik sonrasƒ±)...');
                    // Temizlik sonrasƒ± sayfayƒ± yenile
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                    return; // Script'i durdur
                    
                } catch (e) {
                    console.error('‚ùå Temizleme hatasƒ±:', e);
                }
            } else if (reloadFlag) {
                // Reload sonrasƒ±, flag'i temizle
                sessionStorage.removeItem('botpress_reload_done');
                console.log('‚ÑπÔ∏è Reload tamamlandƒ±, devam ediliyor...');
                // Reload sonrasƒ± artƒ±k yeni kullanƒ±cƒ± deƒüil
                isNewUser = false;
                isNewLogin = false;
            } else {
                console.log('‚ÑπÔ∏è Aynƒ± kullanƒ±cƒ± ve aynƒ± login, normal y√ºkleme');
            }
            
            // Mevcut iframe'i tamamen kaldƒ±r ve yenisini olu≈ütur
            const widgetContainer = document.getElementById('botpress-chat-widget');
            const oldIframe = document.getElementById('botpress-iframe');
            
            if (oldIframe) {
                console.log('üóëÔ∏è Eski iframe kaldƒ±rƒ±lƒ±yor...');
                oldIframe.remove();
            }
            
            // Yeni iframe olu≈ütur
            console.log('üÜï Yeni iframe olu≈üturuluyor...');
            const newIframe = document.createElement('iframe');
            newIframe.id = 'botpress-iframe';
            newIframe.style.cssText = 'width: 100%; height: calc(100% - 60px); border: none; border-radius: 0 0 15px 15px;';
            
            // Sandbox ekle (g√ºvenlik ve izolasyon i√ßin)
            newIframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation');
            
            // Widget'a ekle
            if (widgetContainer) {
                widgetContainer.appendChild(newIframe);
            }
            
            // Botpress URL'sini olu≈ütur
            const botpressBaseUrl = 'https://cdn.botpress.cloud/webchat/v3.5/shareable.html';
            const configUrl = 'https://files.bpcontent.cloud/2026/01/02/15/20260102150846-J1X13IAL.json';
            
            // URL parametreleri - HER SEFERINDE YENƒ∞ userId
            const currentTimestamp = new Date().getTime();
            const botpressUrl = botpressBaseUrl + 
                '?configUrl=' + encodeURIComponent(configUrl) +
                '&userId=' + encodeURIComponent(botpressUserId) +
                '&conversationId=' + encodeURIComponent(conversationId) +
                '&userName=' + encodeURIComponent(fullName) +
                '&userType=' + encodeURIComponent(userType) +
                '&_t=' + currentTimestamp +
                '&_uid=' + userId +
                '&_new=' + (isNewUser ? '1' : '0') +
                '&_reset=true';
            
            console.log('üì° Botpress URL:', botpressUrl);
            
            // iframe'i y√ºkle
            setTimeout(function() {
                newIframe.src = botpressUrl;
                console.log('‚úÖ iframe y√ºklendi');
            }, 100);
            
            // iframe y√ºklendiƒüinde
            newIframe.onload = function() {
                console.log('‚úÖ iframe onload tetiklendi');
                
                try {
                    // Botpress'e kullanƒ±cƒ± bilgilerini g√∂nder
                    setTimeout(function() {
                        // 1. Conversation'ƒ± sƒ±fƒ±rla
                        newIframe.contentWindow.postMessage({
                            type: 'event',
                            event: {
                                type: 'reset'
                            }
                        }, '*');
                        
                        // 2. Yeni conversation ba≈ülat
                        newIframe.contentWindow.postMessage({
                            type: 'event',
                            event: {
                                type: 'conversation.new',
                                conversationId: conversationId
                            }
                        }, '*');
                        
                        // 3. Kullanƒ±cƒ± bilgilerini ayarla - YENƒ∞ userId ile
                        newIframe.contentWindow.postMessage({
                            type: 'setUserId',
                            userId: botpressUserId, // YENƒ∞ userId
                            userData: {
                                id: userId,
                                name: fullName,
                                username: username,
                                userType: userType
                            }
                        }, '*');
                        
                        // 4. Yeni kullanƒ±cƒ± ise ek reset komutlarƒ±
                        if (isNewUser) {
                            newIframe.contentWindow.postMessage({
                                type: 'resetConversation'
                            }, '*');
                            
                            newIframe.contentWindow.postMessage({
                                type: 'event',
                                event: {
                                    type: 'proactive-trigger',
                                    channel: 'web',
                                    payload: {
                                        text: '/reset'
                                    }
                                }
                            }, '*');
                        }
                        
                        console.log('‚úÖ Kullanƒ±cƒ± bilgileri g√∂nderildi');
                        
                        // Yeni kullanƒ±cƒ± ise conversation'ƒ± sƒ±fƒ±rla
                        if (isNewUser) {
                            console.log('‚úÖ Conversation reset komutlarƒ± g√∂nderildi');
                        }
                    }, 1000);
                } catch (e) {
                    console.error('‚ùå postMessage hatasƒ±:', e);
                }
            };
            
            // Widget a√ßma/kapama
            const btn = document.getElementById('botpress-chat-btn');
            const widget = document.getElementById('botpress-chat-widget');
            const closeBtn = document.getElementById('botpress-chat-close');
            
            console.log('üîç Widget elementleri kontrol ediliyor...');
            console.log('Button:', btn ? 'Bulundu' : 'Bulunamadƒ±');
            console.log('Widget:', widget ? 'Bulundu' : 'Bulunamadƒ±');
            console.log('Close Button:', closeBtn ? 'Bulundu' : 'Bulunamadƒ±');
            
            if (btn && widget && closeBtn) {
                console.log('‚úÖ T√ºm widget elementleri hazƒ±r, click event ekleniyor...');
                
                btn.onclick = function() {
                    console.log('üñ±Ô∏è Botpress butonuna tƒ±klandƒ±!');
                    const wasActive = widget.classList.contains('active');
                    widget.classList.toggle('active');
                    
                    // Widget a√ßƒ±lƒ±yorsa ve yeni kullanƒ±cƒ±ysa, iframe'i yeniden y√ºkle
                    if (!wasActive && widget.classList.contains('active')) {
                        console.log('Widget a√ßƒ±lƒ±yor...');
                        
                        // Yeni kullanƒ±cƒ± veya yeni login ise iframe'i tamamen yeniden y√ºkle
                        if (isNewUser || isNewLogin) {
                            console.log('üîÑ Yeni kullanƒ±cƒ±/login i√ßin iframe yeniden y√ºkleniyor...');
                            const currentIframe = document.getElementById('botpress-iframe');
                            if (currentIframe) {
                                const newUrl = currentIframe.src.split('&_reload=')[0] + '&_reload=' + Date.now();
                                currentIframe.src = 'about:blank';
                                setTimeout(function() {
                                    currentIframe.src = newUrl;
                                }, 100);
                            }
                        }
                    }
                    
                    console.log('Widget durumu:', widget.classList.contains('active') ? 'A√ßƒ±k' : 'Kapalƒ±');
                };
                
                closeBtn.onclick = function() {
                    console.log('üñ±Ô∏è Close butonuna tƒ±klandƒ±!');
                    widget.classList.remove('active');
                    console.log('Widget kapatƒ±ldƒ±');
                };
                
                // ESC tu≈üu ile kapat
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && widget.classList.contains('active')) {
                        widget.classList.remove('active');
                        console.log('Widget ESC ile kapatƒ±ldƒ±');
                    }
                });
                
                console.log('‚úÖ Click event ba≈üarƒ±yla eklendi!');
            } else {
                console.error('‚ùå Widget elementleri bulunamadƒ±!');
                if (!btn) console.error('  - Button bulunamadƒ±: #botpress-chat-btn');
                if (!widget) console.error('  - Widget bulunamadƒ±: #botpress-chat-widget');
                if (!closeBtn) console.error('  - Close button bulunamadƒ±: #botpress-chat-close');
            }
            
            // Mevcut kullanƒ±cƒ±yƒ± kaydet
            try {
                localStorage.setItem('botpress_current_user_id', userId);
                localStorage.setItem('botpress_login_timestamp', loginTimestamp);
                localStorage.setItem('botpress_session_id', sessionId);
                localStorage.setItem('botpress_user_name', fullName);
                localStorage.setItem('botpress_user_type', userType);
                localStorage.setItem('botpress_last_load', new Date().getTime().toString());
                console.log('‚úÖ Kullanƒ±cƒ± bilgileri kaydedildi');
            } catch (e) {
                console.error('‚ùå LocalStorage kayƒ±t hatasƒ±:', e);
            }
            
            console.log('=== BOTPRESS BA≈ûLATMA TAMAMLANDI ===');
        })();
    </script>
    {% endif %}

    {% block extra_css %}{% endblock %}

    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Modern Navbar Styles - Sabit ve tutarlƒ± */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 1rem 0 !important;
            min-height: 76px !important;
            z-index: 1050;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            margin: 0 !important;
        }

        /* Navbar container - tutarlƒ± geni≈ülik her sayfada */
        .navbar .container-fluid {
            max-width: 100% !important;
            width: 100% !important;
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
            margin: 0 !important;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: white !important;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            transform: scale(1.05);
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 0 0.2rem;
        }

        .navbar-nav .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white !important;
            transform: translateY(-1px);
        }

        .navbar-nav .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 1.2rem;
            padding: 0.5rem !important;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white !important;
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: 0.2rem;
            right: 0.2rem;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Dropdown Styles */
        .dropdown-menu {
            border: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            padding: 0.75rem 0;
            margin-top: 0.5rem;
            z-index: 10000 !important;
            min-width: 200px;
        }

        .dropdown {
            position: relative;
            z-index: 1051;
        }

        .dropdown-item {
            padding: 0.75rem 1.25rem;
            transition: all 0.2s ease;
            border: none;
            margin: 0.1rem 0.5rem;
            border-radius: 6px;
            width: calc(100% - 1rem);
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white !important;
            transform: none;
        }

        .dropdown-item.user-menu-item:hover {
            transform: none !important;
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10001 !important;
        }

        /* Ensure notification items are clickable */
        .notification-item {
            position: relative;
            z-index: 10002;
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: rgba(102, 126, 234, 0.05);
            border-left: 3px solid #667eea;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .notification-text {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .notification-time {
            color: #999;
            font-size: 0.8rem;
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .btn {
            border-radius: 0.375rem;
        }

        main {
            flex: 1;
            margin-top: 76px;
            /* Navbar y√ºksekliƒüi */
            padding-top: 1.5rem;
            /* Navbar ile i√ßerik arasƒ± bo≈üluk */
            width: 100%;
            overflow-x: hidden !important;
            box-sizing: border-box;
        }

        body {
            overflow-x: hidden !important;
        }

        .footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 1.5rem 0;
            margin-top: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .notification-dropdown {
                width: 300px;
            }

            .navbar-brand {
                font-size: 1.2rem;
            }

            .container-fluid {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            /* Fix card overflow */
            .card {
                margin-bottom: 1rem;
            }

            .row {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            .row>* {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }

        @media (max-width: 576px) {
            .navbar .container-fluid {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .navbar-nav .nav-link {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.9rem;
            }

            .dropdown-menu {
                min-width: 180px;
                font-size: 0.9rem;
            }

            /* Prevent horizontal scroll */
            body,
            html {
                overflow-x: hidden !important;
            }

            .container-fluid {
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
        }
    </style>
</head>
<body class="{% if user.is_authenticated %}{{ user_type }}{% endif %}" {% if user.is_authenticated %}data-user-id="{{ user.id }}"{% endif %}>
    {% get_user_type user as user_type %}

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Modern Sidebar (√ñƒürenci i√ßin) -->
    {% if user.is_authenticated and user_type == 'student' %}
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-user-graduate"></i>
                √ñƒürenci Paneli
            </h3>
            <div class="user-info">
                {{ user.first_name }} {{ user.last_name }}
            </div>
            <button id="sidebar-hide" class="sidebar-hide-btn" type="button" title="Men√ºy√º gizle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <ul class="sidebar-menu">
            <li class="sidebar-category">Ana Men√º</li>
            <li>
                <a href="{% url 'students:dashboard' %}">
                    <i class="fas fa-home"></i>
                    Ana Sayfa
                </a>
            </li>
            <li>
                <a href="{% url 'students:courses' %}">
                    <i class="fas fa-book"></i>
                    Derslerim
                </a>
            </li>

            <li class="sidebar-category">Akademik</li>
            <li>
                <a href="{% url 'gradebook:my_grades' %}">
                    <i class="fas fa-star"></i>
                    Notlarƒ±m
                </a>
            </li>
            <li>
                <a href="{% url 'gradebook:transcript' %}">
                    <i class="fas fa-file-alt"></i>
                    Transkript
                </a>
            </li>
            <li>
                <a href="{% url 'courses:assignment_list' %}">
                    <i class="fas fa-tasks"></i>
                    √ñdevlerim
                </a>
            </li>
            <li>
                <a href="{% url 'quiz:quiz_list_student' %}">
                    <i class="fas fa-clipboard-list"></i>
                    Sƒ±navlar
                </a>
            </li>

            <li class="sidebar-category">ƒ∞leti≈üim</li>
            <li>
                <a href="{% url 'forum:inbox' %}">
                    <i class="fas fa-envelope"></i>
                    Mesajlarƒ±m
                </a>
            </li>
            <li>
                <a href="{% url 'users:notifications' %}">
                    <i class="fas fa-bell"></i>
                    Bildirimler
                </a>
            </li>

            <li class="sidebar-category">Hesap</li>
            <li>
                <a href="{% url 'users:profile' %}">
                    <i class="fas fa-user-circle"></i>
                    Profilim
                </a>
            </li>
            <li>
                <a href="{% url 'users:logout' %}">
                    <i class="fas fa-sign-out-alt"></i>
                    √áƒ±kƒ±≈ü Yap
                </a>
            </li>
        </ul>
    </div>
    {% endif %}

    <!-- Modern Sidebar (√ñƒüretmen i√ßin) -->
    {% if user.is_authenticated and user_type == 'teacher' %}
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-chalkboard-teacher"></i>
                √ñƒüretmen Paneli
            </h3>
            <div class="user-info">
                {{ user.first_name }} {{ user.last_name }}
            </div>
            <button id="sidebar-hide" class="sidebar-hide-btn" type="button" title="Men√ºy√º gizle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <ul class="sidebar-menu">
            <li class="sidebar-category">Ana Men√º</li>
            <li>
                <a href="{% url 'teachers:dashboard' %}">
                    <i class="fas fa-home"></i>
                    Ana Sayfa
                </a>
            </li>
            <li>
                <a href="{% url 'teachers:courses' %}">
                    <i class="fas fa-book"></i>
                    Derslerim
                </a>
            </li>
            <li>
                <a href="{% url 'courses:assignment_list' %}">
                    <i class="fas fa-tasks"></i>
                    √ñdevler
                </a>
            </li>
            <li>
                <a href="{% url 'teachers:students' %}">
                    <i class="fas fa-user-graduate"></i>
                    √ñƒürencilerim
                </a>
            </li>
            <li>
                <a href="{% url 'quiz:question_bank_list' %}">
                    <i class="fas fa-question-circle"></i>
                    Soru Bankasƒ±
                </a>
            </li>
            <li class="sidebar-parent">
                <a href="{% url 'quiz:quiz_list' %}">
                    <i class="fas fa-clipboard-list"></i>
                    Sƒ±navlar
                </a>
                <ul class="sidebar-submenu">
                    <li>
                        <a href="{% url 'quiz:quiz_list' %}">
                            <i class="fas fa-list"></i>
                            T√ºm Sƒ±navlar
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'quiz:quiz_create_default' %}">
                            <i class="fas fa-plus-circle"></i>
                            Sƒ±nav Olu≈ütur
                        </a>
                    </li>
                </ul>
            </li>
            
            <li class="sidebar-category">Notlandƒ±rma</li>
            <li class="sidebar-parent">
                <a href="{% url 'gradebook:teacher_default' %}">
                    <i class="fas fa-clipboard-check"></i>
                    Notlandƒ±rma
                </a>
                <ul class="sidebar-submenu">
                    <li>
                        <a href="{% url 'gradebook:teacher_default' %}">
                            <i class="fas fa-book-open"></i>
                            Not Defteri
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'courses:assignment_list' %}?state=expired">
                            <i class="fas fa-star"></i>
                            √ñdev Notlandƒ±rma
                        </a>
                    </li>
                </ul>
            </li>

            <li class="sidebar-category">ƒ∞leti≈üim</li>
            <li class="sidebar-parent">
                <a href="{% url 'forum:inbox' %}">
                    <i class="fas fa-envelope"></i>
                    Mesaj & Bildirim
                    {% if unread_messages > 0 %}
                    <span class="badge">{{ unread_messages }}</span>
                    {% endif %}
                </a>
                <ul class="sidebar-submenu">
                    <li>
                        <a href="{% url 'forum:inbox' %}">
                            <i class="fas fa-envelope-open-text"></i>
                            Mesajlarƒ±m
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'users:notifications' %}">
                            <i class="fas fa-bell"></i>
                            Bildirimler
                        </a>
                    </li>
                </ul>
            </li>

            <li class="sidebar-category">Hesap</li>
            <li>
                <a href="{% url 'users:profile' %}">
                    <i class="fas fa-user-circle"></i>
                    Profilim
                </a>
            </li>
            <li>
                <a href="{% url 'users:logout' %}">
                    <i class="fas fa-sign-out-alt"></i>
                    √áƒ±kƒ±≈ü Yap
                </a>
            </li>
        </ul>
    </div>
    {% endif %}

    <!-- Modern Sidebar (Admin i√ßin) -->
    {% if user.is_authenticated and user_type != 'student' and user_type != 'teacher' %}
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-user-shield"></i>
                Admin Paneli
            </h3>
            <div class="user-info">
                {{ user.first_name }} {{ user.last_name }}
            </div>
            <button id="sidebar-hide" class="sidebar-hide-btn" type="button" title="Men√ºy√º gizle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <ul class="sidebar-menu">
            <li class="sidebar-category">Ana Men√º</li>
            <li>
                <a href="{% url 'admin:index' %}">
                    <i class="fas fa-tachometer-alt"></i>
                    Admin Dashboard
                </a>
            </li>
            <li>
                <a href="{% url 'home' %}">
                    <i class="fas fa-home"></i>
                    Ana Sayfa
                </a>
            </li>

            <li class="sidebar-category">Ders Y√∂netimi</li>
            <li>
                <a href="{% url 'courses:list' %}">
                    <i class="fas fa-book"></i>
                    Dersler
                </a>
            </li>
            <li>
                <a href="{% url 'courses:teacher_assignment' %}">
                    <i class="fas fa-link"></i>
                    √ñƒüretmen-Ders Atama
                </a>
            </li>
            <li>
                <a href="{% url 'courses:enrollment_list' %}">
                    <i class="fas fa-clipboard-list"></i>
                    Ders Kayƒ±tlarƒ±
                </a>
            </li>

            <li class="sidebar-category">Kullanƒ±cƒ±lar</li>
            <li>
                <a href="{% url 'students:list' %}">
                    <i class="fas fa-user-graduate"></i>
                    √ñƒürenciler
                </a>
            </li>
            <li>
                <a href="{% url 'teachers:list' %}">
                    <i class="fas fa-chalkboard-teacher"></i>
                    √ñƒüretmenler
                </a>
            </li>
            <li>
                <a href="{% url 'users:user_list' %}">
                    <i class="fas fa-users"></i>
                    T√ºm Kullanƒ±cƒ±lar
                </a>
            </li>

            <li class="sidebar-category">Eƒüitim ƒ∞√ßerikleri</li>
            <li>
                <a href="{% url 'admin:quiz_quiz_changelist' %}">
                    <i class="fas fa-clipboard-check"></i>
                    Sƒ±navlar
                </a>
            </li>
            <li>
                <a href="{% url 'admin:quiz_questionbank_changelist' %}">
                    <i class="fas fa-database"></i>
                    Soru Bankalarƒ±
                </a>
            </li>
            <li>
                <a href="{% url 'courses:assignment_list' %}">
                    <i class="fas fa-tasks"></i>
                    √ñdevler
                </a>
            </li>

            <li class="sidebar-category">Sistem</li>
            <li>
                <a href="{% url 'admin:academic_academicterm_changelist' %}">
                    <i class="fas fa-calendar"></i>
                    Akademik D√∂nemler
                </a>
            </li>
            <li>
                <a href="{% url 'admin:utils_systemannouncement_changelist' %}">
                    <i class="fas fa-bullhorn"></i>
                    Sistem Duyurularƒ±
                </a>
            </li>
            <li>
                <a href="{% url 'admin:utils_activitylog_changelist' %}">
                    <i class="fas fa-chart-line"></i>
                    Sistem Loglarƒ±
                </a>
            </li>

            <li class="sidebar-category">Hesap</li>
            <li>
                <a href="{% url 'users:profile' %}">
                    <i class="fas fa-user-circle"></i>
                    Profilim
                </a>
            </li>
            <li>
                <a href="{% url 'users:logout' %}">
                    <i class="fas fa-sign-out-alt"></i>
                    √áƒ±kƒ±≈ü Yap
                </a>
            </li>
        </ul>
    </div>
    {% endif %}

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            {% if user.is_authenticated %}
            <button id="sidebar-toggle-nav" class="btn btn-outline-light me-2" type="button" title="Men√º" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            {% endif %}
            <a class="navbar-brand" href="{% url 'home' %}" id="navbar-brand-toggle" style="cursor: pointer;">
                <i class="fas fa-graduation-cap me-2"></i>
                {% if user_type == 'student' %}√ñƒürenci Paneli
                {% elif user_type == 'teacher' %}√ñƒüretmen Paneli
                {% else %}Y√∂netim Paneli{% endif %}
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {# √ñƒürenci ve √∂ƒüretmen i√ßin √ºst men√ºleri gizle (t√ºm i≈ülevler solda) #}
                    {% if user.is_authenticated and user_type != 'student' and user_type != 'teacher' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">
                            <i class="fas fa-home me-1"></i>Ana Sayfa
                        </a>
                    </li>



                    {% if user_type == 'teacher' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'teachers:courses' %}">
                            <i class="fas fa-book me-1"></i>Derslerim
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'courses:assignment_list' %}">
                            <i class="fas fa-tasks me-1"></i>√ñdevler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'students:list' %}">
                            <i class="fas fa-user-graduate me-1"></i>√ñƒürencilerim
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'quiz:question_bank_list' %}">
                            <i class="fas fa-question-circle me-1"></i>Soru Bankasƒ±
                        </a>
                    </li>
                    {# Quizler ve Soru Alanƒ± ge√ßici olarak kaldƒ±rƒ±ldƒ± #}
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'courses:list' %}">
                            <i class="fas fa-book me-1"></i>Dersler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'courses:teacher_assignment' %}">
                            <i class="fas fa-user-plus me-1"></i>√ñƒüretmen-Ders Atama
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'students:list' %}">
                            <i class="fas fa-user-graduate me-1"></i>√ñƒürenciler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'teachers:list' %}">
                            <i class="fas fa-chalkboard-teacher me-1"></i>√ñƒüretmenler
                        </a>
                    </li>

                    {# Quizler ve Soru Alanƒ± ge√ßici olarak kaldƒ±rƒ±ldƒ± #}

                    {% endif %}
                    {% endif %}
                </ul>

                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                    <!-- Messages Icon -->
                    <li class="nav-item me-2">
                        <a class="nav-link notification-bell" href="{% url 'forum:inbox' %}" title="Mesajlar">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </li>
                    
                    <!-- Notifications -->
                    <li class="nav-item dropdown">
                        <a class="nav-link notification-bell" href="#" id="notificationDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            {% if unread_notifications_count > 0 %}
                            <span class="notification-badge" id="notificationCount">
                                {{ unread_notifications_count }}
                            </span>
                            {% endif %}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end notification-dropdown"
                            aria-labelledby="notificationDropdown">
                            <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                                <h6 class="mb-0 fw-bold">Bildirimler</h6>
                                <small class="text-muted">{{ unread_notifications_count|default:0 }} yeni</small>
                            </div>

                            <!-- Real Notifications (Sadece Okunmamƒ±≈ülar) -->
                            {% if navbar_notifications %}
                                {% for notification in navbar_notifications %}
                                <a href="{{ notification.url|default:'#' }}" class="notification-item unread"
                                    data-notification-id="{{ notification.id }}"
                                    data-notification-url="{{ notification.url|default:'#' }}"
                                    style="text-decoration: none; color: inherit; display: block;">
                                    <div class="notification-title">{{ notification.title }}</div>
                                    <div class="notification-text">{{ notification.message|truncatewords:12 }}</div>
                                    <div class="notification-time">{{ notification.time }}</div>
                                </a>
                                {% endfor %}
                            {% else %}
                                <div class="notification-item">
                                    <div class="notification-title">Hen√ºz bildirim yok</div>
                                    <div class="notification-text">Yeni bildirimler burada g√∂r√ºnecektir</div>
                                </div>
                            {% endif %}

                            <div class="text-center py-2 border-top">
                                <a href="{% url 'users:notifications' %}" class="btn btn-sm btn-outline-primary">T√ºm√ºn√º
                                    G√∂r√ºnt√ºle</a>
                            </div>
                        </div>
                    </li>

                    <!-- User Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ user.get_full_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item user-menu-item" href="{% url 'users:profile' %}">
                                    <i class="fas fa-id-card me-2"></i>Profilim
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item user-menu-item" href="{% url 'users:logout' %}">
                                    <i class="fas fa-sign-out-alt me-2"></i>√áƒ±kƒ±≈ü
                                </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'users:login' %}">
                            <i class="fas fa-sign-in-alt me-1"></i>Giri≈ü
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'users:register' %}">
                            <i class="fas fa-user-plus me-1"></i>Kayƒ±t Ol
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <main id="main-content"
        class="{% if user.is_authenticated and user_type == 'student' %}student-main{% elif user.is_authenticated and user_type == 'teacher' %}teacher-main{% elif user.is_authenticated %}admin-main{% endif %}"
        style="width: 100%; overflow-x: hidden;">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Utilities -->
    <script src="{% static 'js/app-utils.js' %}"></script>
    <!-- Modern Interactions -->
    <script src="{% static 'js/modern-interactions.js' %}"></script>

    <!-- Sidebar JS -->
    <script src="{% static 'js/sidebar.js' %}"></script>

    <!-- Floating Chat Widget (only for authenticated users) -->
    {% if user.is_authenticated %}
    <script src="{% static 'js/floating-chat.js' %}"></script>
    <script>
        // Debug: Floating chat y√ºklendiƒüini kontrol et
        console.log('[Floating Chat] Script loaded');
        setTimeout(() => {
            const floatingBtn = document.getElementById('floating-chat-btn');
            const chatWidget = document.getElementById('chat-widget');
            console.log('[Floating Chat] Button exists:', !!floatingBtn);
            console.log('[Floating Chat] Widget exists:', !!chatWidget);
            if (floatingBtn) {
                console.log('[Floating Chat] Button position:', window.getComputedStyle(floatingBtn).position);
                console.log('[Floating Chat] Button right:', window.getComputedStyle(floatingBtn).right);
                console.log('[Floating Chat] Button bottom:', window.getComputedStyle(floatingBtn).bottom);
            }
        }, 1000);
    </script>
    {% endif %}

    <!-- Notification System JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Notification interactions
            const notificationItems = document.querySelectorAll('.notification-item');
            const notificationBadge = document.getElementById('notificationCount');

            // Mark notification as read when clicked
            notificationItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    const notificationId = this.getAttribute('data-notification-id');
                    const notificationUrl = this.getAttribute('data-notification-url');
                    
                    if (this.classList.contains('unread') && notificationId) {
                        e.preventDefault(); // √ñnce linki engelle
                        
                        // Remove unread class immediately for better UX
                        this.classList.remove('unread');

                        // Update notification count
                        if (notificationBadge) {
                            let currentCount = parseInt(notificationBadge.textContent) || 0;
                            if (currentCount > 0) {
                                currentCount--;
                                notificationBadge.textContent = currentCount;

                                // Hide badge if no unread notifications
                                if (currentCount === 0) {
                                    notificationBadge.style.display = 'none';
                                }
                            }
                        }
                        
                        // Bildirimi dropdown'dan kaldƒ±r
                        this.style.display = 'none';
                        
                        // Send AJAX request to mark as read in backend
                        fetch('{% url "users:mark_notification_read" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({
                                notification_id: notificationId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update badge count immediately
                                updateNotificationBadge();
                                
                                // Backend'de i≈üaretlendi, ≈üimdi sayfaya y√∂nlendir
                                if (notificationUrl && notificationUrl !== '#') {
                                    window.location.href = notificationUrl;
                                }
                            } else {
                                console.error('Bildirim i≈üaretlenirken hata:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('AJAX hatasƒ±:', error);
                            // Hata olsa bile y√∂nlendir
                            if (notificationUrl && notificationUrl !== '#') {
                                window.location.href = notificationUrl;
                            }
                        });
                    }
                });
            });
            
            // Helper function to get CSRF token
            function getCsrfToken() {
                const match = document.cookie.match(/csrftoken=([^;]+)/);
                return match ? match[1] : '';
            }
            
            // Helper function to update notification badge count
            function updateNotificationBadge() {
                fetch('/api/notifications/unread-count/')
                    .then(response => response.json())
                    .then(data => {
                        const badge = document.getElementById('notificationCount');
                        if (badge) {
                            if (data.count > 0) {
                                badge.textContent = data.count;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Badge update error:', error);
                    });
            }

            // Add active class to current page nav link
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });

            // Navbar scroll animasyonu kaldƒ±rƒ±ldƒ± - sabit kalacak
            // Navbar artƒ±k her zaman g√∂r√ºn√ºr olacak

            // Add notification sound effect (optional)
            function playNotificationSound() {
                // Create audio context for notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            // Simulate new notification (for demo purposes)
            setTimeout(() => {
                // This would be replaced with real-time notification system
                console.log('New notification received!');
                // playNotificationSound(); // Uncomment to enable sound
            }, 5000);
        });

        // Real-time notification updates (placeholder for WebSocket integration)
        function updateNotifications() {
            // This function would be called when new notifications arrive
            // via WebSocket or periodic AJAX calls

            fetch('/api/notifications/unread-count/')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notificationCount');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.log('Notification update failed:', error));
        }

        // Update notifications every 30 seconds (optional)
        // setInterval(updateNotifications, 30000);
    </script>

    {% block extra_js %}{% endblock %}

    <!-- Lazy Loading Script -->
    <script>
        // Lazy Loading i√ßin IntersectionObserver
        document.addEventListener('DOMContentLoaded', function () {
            // Lazy load i√ßin kartlarƒ± i≈üaretle
            const lazyCards = document.querySelectorAll('.lazy-card');

            if ('IntersectionObserver' in window) {
                const cardObserver = new IntersectionObserver(function (entries, observer) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            const card = entry.target;
                            card.classList.add('lazy-loaded');
                            card.style.opacity = '0';
                            card.style.transition = 'opacity 0.3s ease-in';

                            // Fade-in animasyonu
                            setTimeout(function () {
                                card.style.opacity = '1';
                            }, 50);

                            observer.unobserve(card);
                        }
                    });
                }, {
                    rootMargin: '50px' // Kartlar g√∂r√ºn√ºr alana 50px yakla≈ütƒ±ƒüƒ±nda y√ºkle
                });

                lazyCards.forEach(function (card) {
                    cardObserver.observe(card);
                });
            } else {
                // IntersectionObserver desteklenmiyorsa t√ºm kartlarƒ± g√∂ster
                lazyCards.forEach(function (card) {
                    card.classList.add('lazy-loaded');
                    card.style.opacity = '1';
                });
            }

            // G√∂rseller i√ßin native lazy loading (tarayƒ±cƒ± desteƒüi varsa)
            const lazyImages = document.querySelectorAll('img[data-src]');
            if ('loading' in HTMLImageElement.prototype) {
                lazyImages.forEach(function (img) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                });
            } else {
                // Fallback: IntersectionObserver ile g√∂rsel lazy loading
                const imageObserver = new IntersectionObserver(function (entries, observer) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            observer.unobserve(img);
                        }
                    });
                });

                lazyImages.forEach(function (img) {
                    imageObserver.observe(img);
                });
            }
        });
    </script>

    <!-- Floating Chat Widget - Teacher-Student Messaging -->
    <!-- Position: Bottom-RIGHT corner -->
    
    <style>
        /* ============================================
           FLOATING CHAT - SAƒû ALT (√ñƒürenci-√ñƒüretmen)
           ============================================ */
        
        /* Floating chat button - Saƒü alt */
        #floating-chat-btn {
            position: fixed !important;
            right: 24px !important;
            left: auto !important;
            bottom: 24px !important;
            z-index: 99999 !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: #fff !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            box-shadow: 0 4px 18px rgba(0,0,0,0.25) !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #floating-chat-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(0,0,0,0.35) !important;
        }
        
        /* Floating chat window - Saƒü alt */
        #chat-widget {
            position: fixed !important;
            right: 24px !important;
            left: auto !important;
            bottom: 90px !important;
            z-index: 99998 !important;
            width: 420px !important;
            max-width: calc(100vw - 32px) !important;
            height: 560px !important;
            visibility: visible !important;
            display: none !important;
        }
        
        #chat-widget.active {
            display: flex !important;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            #gemini-chat-btn {
                left: 16px !important;
                bottom: 16px !important;
                width: 52px !important;
                height: 52px !important;
            }
            
            #gemini-chat-widget {
                left: 16px !important;
                bottom: 80px !important;
                width: calc(100vw - 32px) !important;
                height: 480px !important;
            }
            
            #floating-chat-btn {
                right: 16px !important;
                bottom: 16px !important;
                width: 52px !important;
                height: 52px !important;
            }
            
            #chat-widget {
                right: 16px !important;
                bottom: 80px !important;
                width: calc(100vw - 32px) !important;
                height: 480px !important;
            }
        }
    </style>

</body>

</html>
