{% extends 'base.html' %}

{% block title %}Ã‡Ä±kÄ±ÅŸ YapÄ±ldÄ±{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-sign-out-alt fa-4x text-success"></i>
                    </div>
                    <h2 class="card-title mb-3">BaÅŸarÄ±yla Ã‡Ä±kÄ±ÅŸ YaptÄ±nÄ±z</h2>
                    <p class="text-muted mb-4">
                        GÃ¼venli bir ÅŸekilde sistemden Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z. Tekrar gÃ¶rÃ¼ÅŸmek Ã¼zere!
                    </p>
                    <div class="alert alert-info mb-4" id="cleanup-status">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Oturum verileri temizleniyor...
                    </div>
                    <a href="{% url 'login' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Tekrar GiriÅŸ Yap
                    </a>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-lg ms-2">
                        <i class="fas fa-home me-2"></i>
                        Ana Sayfa
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda Botpress chatbot verilerini AGRESÄ°F TEMÄ°ZLE
    (function() {
        const statusDiv = document.getElementById('cleanup-status');
        
        function updateStatus(message, isComplete = false) {
            if (statusDiv) {
                if (isComplete) {
                    statusDiv.className = 'alert alert-success mb-4';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message;
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + message;
                }
            }
        }
        
        try {
            console.log('ğŸ—‘ï¸ LOGOUT: TÃ¼m Botpress verileri temizleniyor...');
            updateStatus('Oturum verileri temizleniyor...');
            
            // 1. SessionStorage - Login timestamp'i de dahil TAMAMEN temizle
            sessionStorage.clear();
            console.log('âœ… SessionStorage tamamen temizlendi (login timestamp dahil)');
            
            // 2. LocalStorage - TÃœM Botpress anahtarlarÄ±nÄ± temizle
            const allKeys = Object.keys(localStorage);
            let cleanedCount = 0;
            allKeys.forEach(key => {
                if (key.includes('botpress') || 
                    key.includes('bp-') || 
                    key.includes('bp_') ||
                    key.startsWith('bp') ||
                    key.includes('webchat') ||
                    key.includes('conversation') ||
                    key.includes('conv-') ||
                    key.includes('messaging') ||
                    key.includes('chat')) {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    console.log('ğŸ—‘ï¸ Temizlendi:', key);
                }
            });
            console.log('âœ… LocalStorage temizlendi:', cleanedCount, 'anahtar');
            updateStatus('LocalStorage temizlendi (' + cleanedCount + ' Ã¶ÄŸe)');
            
            // 3. Cookies - Botpress cookie'lerini agresif temizle (TÃœM domain'ler iÃ§in)
            updateStatus('Ã‡erezler temizleniyor...');
            const cookies = document.cookie.split(";");
            let cookieCount = 0;
            cookies.forEach(function(c) {
                const cookieName = c.split("=")[0].trim();
                if (cookieName.includes('botpress') || 
                    cookieName.includes('bp-') || 
                    cookieName.includes('bp_') ||
                    cookieName.startsWith('bp') ||
                    cookieName.includes('webchat')) {
                    
                    // Cookie'yi tÃ¼m path'ler ve domain'ler iÃ§in sil
                    const domains = [
                        '',
                        window.location.hostname,
                        '.' + window.location.hostname,
                        '.botpress.cloud',
                        '.bpcontent.cloud',
                        'cdn.botpress.cloud',
                        'files.bpcontent.cloud'
                    ];
                    const paths = ['/', '/webchat', '/chat', '/v3.5', ''];
                    
                    domains.forEach(domain => {
                        paths.forEach(path => {
                            // FarklÄ± kombinasyonlar dene
                            if (domain) {
                                document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=" + path + ";domain=" + domain + ";";
                            } else {
                                document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=" + path + ";";
                            }
                        });
                    });
                    
                    cookieCount++;
                    console.log('ğŸ—‘ï¸ Cookie silindi:', cookieName);
                }
            });
            console.log('âœ… Cookies temizlendi:', cookieCount, 'Ã§erez');
            updateStatus('Ã‡erezler temizlendi (' + cookieCount + ' Ã§erez)');
            
            // 4. IndexedDB - Botpress veritabanlarÄ±nÄ± sil
            updateStatus('VeritabanlarÄ± temizleniyor...');
            if (window.indexedDB && window.indexedDB.databases) {
                indexedDB.databases().then(databases => {
                    let dbCount = 0;
                    databases.forEach(db => {
                        if (db.name && (db.name.includes('botpress') || 
                                       db.name.includes('bp-') || 
                                       db.name.includes('webchat'))) {
                            indexedDB.deleteDatabase(db.name);
                            dbCount++;
                            console.log('ğŸ—‘ï¸ IndexedDB silindi:', db.name);
                        }
                    });
                    console.log('âœ… IndexedDB temizlendi:', dbCount, 'veritabanÄ±');
                    
                    // TamamlandÄ± mesajÄ±
                    setTimeout(function() {
                        updateStatus('TÃ¼m oturum verileri baÅŸarÄ±yla temizlendi!', true);
                        console.log('âœ… LOGOUT: Botpress chatbot verileri tamamen temizlendi!');
                        console.log('â„¹ï¸ Bir sonraki login\'de yeni bir Botpress session baÅŸlayacak');
                    }, 500);
                }).catch(e => {
                    console.log('IndexedDB temizlenemedi:', e);
                    updateStatus('Temizleme tamamlandÄ± (bazÄ± veriler temizlenemedi)', true);
                });
            } else {
                // IndexedDB yoksa direkt tamamlandÄ±
                setTimeout(function() {
                    updateStatus('TÃ¼m oturum verileri baÅŸarÄ±yla temizlendi!', true);
                    console.log('âœ… LOGOUT: Botpress chatbot verileri tamamen temizlendi!');
                    console.log('â„¹ï¸ Bir sonraki login\'de yeni bir Botpress session baÅŸlayacak');
                }, 500);
            }
            
        } catch (e) {
            console.log('âŒ Chatbot verileri temizlenirken hata:', e);
            updateStatus('Temizleme sÄ±rasÄ±nda bir hata oluÅŸtu', true);
        }
    })();
</script>
{% endblock %}
