{% extends 'base.html' %}
{% load static %}

{% block title %}{{ quiz.title }} - Sonuçlar{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        margin: 0 auto;
        border: 5px solid white;
    }
    
    .score-excellent {
        background: #28a745;
    }
    
    .score-good {
        background: #17a2b8;
    }
    
    .score-average {
        background: #ffc107;
    }
    
    .score-poor {
        background: #dc3545;
    }
    
    .question-review-card {
        margin-bottom: 1.5rem;
        border-left: 4px solid #dee2e6;
    }
    
    .question-review-card.correct {
        border-left-color: #28a745;
        background: #f8fff9;
    }
    
    .question-review-card.incorrect {
        border-left-color: #dc3545;
        background: #fff8f8;
    }
    
    .question-review-card.pending {
        border-left-color: #ffc107;
        background: #fffef8;
    }
    
    .answer-option {
        padding: 0.5rem;
        border-radius: 5px;
        margin: 0.25rem 0;
    }
    
    .answer-option.correct {
        background: #d4edda;
        border: 1px solid #c3e6cb;
    }
    
    .answer-option.selected {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
    }
    
    .answer-option.selected.incorrect {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
    }

    .submission-message {
        text-align: center;
        padding: 3rem 2rem;
    }

    .submission-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if quiz.show_results_immediately %}
        <!-- Show Results Immediately Mode -->
        <!-- Result Header -->
        <div class="result-header text-center">
            <h2><i class="fas fa-clipboard-check"></i> {{ quiz.title }}</h2>
            <p class="mb-4">{{ quiz.description }}</p>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="score-circle {% if attempt.percentage >= 80 %}score-excellent{% elif attempt.percentage >= 60 %}score-good{% elif attempt.percentage >= 40 %}score-average{% else %}score-poor{% endif %}">
                        {% if attempt.percentage is not None %}
                            {{ attempt.percentage|floatformat:0 }}%
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <h4 class="mt-3">Puan</h4>
                </div>
                <div class="col-md-4">
                    <h3>{{ attempt.score|default:"-" }}/{{ quiz.total_points }}</h3>
                    <p>Toplam Puan</p>
                </div>
                <div class="col-md-4">
                    <h3>{{ attempt.get_status_display }}</h3>
                    <p>Durum</p>
                    {% if attempt.submitted_at %}
                    <small>Teslim: {{ attempt.submitted_at|date:"d.m.Y H:i" }}</small>
                    {% endif %}
                </div>
            </div>
            
            {% if attempt.percentage is not None and attempt.percentage >= quiz.passing_score %}
            <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle"></i> <strong>Tebrikler!</strong> Bu sınavı başarıyla geçtiniz.
            </div>
            {% elif attempt.percentage is not None %}
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i> Geçme notu: {{ quiz.passing_score }}%. Geçmek için daha fazla çalışmanız gerekiyor.
            </div>
            {% endif %}
        </div>
        
        <!-- Quiz Questions Review -->
        <h3 class="mb-4"><i class="fas fa-list"></i> Soru İncelemesi</h3>
        
        {% for item in questions_with_answers %}
        {% with question=item.question quiz_question=item.quiz_question answer=item.answer %}
        <div class="card question-review-card {% if answer.is_correct == True %}correct{% elif answer.is_correct == False %}incorrect{% else %}pending{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Soru {{ forloop.counter }} 
                    {% if answer %}
                    <span class="badge bg-{% if answer.is_correct == True %}success{% elif answer.is_correct == False %}danger{% else %}warning{% endif %}">
                        {% if answer.is_correct == True %}
                            <i class="fas fa-check"></i> Doğru
                        {% elif answer.is_correct == False %}
                            <i class="fas fa-times"></i> Yanlış
                        {% else %}
                            <i class="fas fa-clock"></i> Beklemede
                        {% endif %}
                    </span>
                    {% else %}
                    <span class="badge bg-secondary">
                        <i class="fas fa-minus"></i> Cevaplanmadı
                    </span>
                    {% endif %}
                </h5>
                <span class="badge bg-primary">{% if answer %}{{ answer.points_earned|default:0 }}{% else %}0{% endif %}/{{ quiz_question.points }} puan</span>
            </div>
            <div class="card-body">
                <p class="lead"><strong>{{ question.question_text }}</strong></p>
                
                {% if question.question_image %}
                <img src="{{ question.question_image.url }}" class="img-fluid mb-3" style="max-width: 500px;">
                {% endif %}
                
                {% if question.question_type == 'multiple_choice' %}
                <!-- Multiple Choice Review -->
                <div class="mb-3">
                    <strong>Seçenekler:</strong>
                    <div class="mt-2">
                        <div class="answer-option {% if 'A' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'A' %}selected{% if answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>A)</strong> {{ question.option_a }}
                            {% if 'A' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'A' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        <div class="answer-option {% if 'B' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'B' %}selected{% if answer and answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>B)</strong> {{ question.option_b }}
                            {% if 'B' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'B' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        {% if question.option_c %}
                        <div class="answer-option {% if 'C' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'C' %}selected{% if answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>C)</strong> {{ question.option_c }}
                            {% if 'C' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'C' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if question.option_d %}
                        <div class="answer-option {% if 'D' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'D' %}selected{% if answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>D)</strong> {{ question.option_d }}
                            {% if 'D' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'D' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if question.option_e %}
                        <div class="answer-option {% if 'E' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'E' %}selected{% if answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>E)</strong> {{ question.option_e }}
                            {% if 'E' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'E' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% elif question.question_type == 'true_false' %}
                <!-- True/False Review -->
                <div class="mb-3">
                    <strong>Seçenekler:</strong>
                    <div class="mt-2">
                        <div class="answer-option {% if 'T' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'T' %}selected{% if answer and answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>Doğru</strong>
                            {% if 'T' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'T' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                        <div class="answer-option {% if 'F' == question.correct_answer %}correct{% endif %} {% if answer and answer.selected_option == 'F' %}selected{% if answer and answer.selected_option != question.correct_answer %}incorrect{% endif %}{% endif %}">
                            <strong>Yanlış</strong>
                            {% if 'F' == question.correct_answer %}
                                <i class="fas fa-check-circle text-success float-end"></i>
                            {% endif %}
                            {% if answer and answer.selected_option == 'F' %}
                                <i class="fas fa-arrow-left text-primary float-end me-2"></i> <small class="text-muted">Sizin cevabınız</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% elif question.question_type == 'short_answer' or question.question_type == 'essay' %}
                <!-- Short Answer / Essay Review -->
                <div class="mb-3">
                    <strong>Sizin Cevabınız:</strong>
                    <div class="alert alert-info mt-2">
                        {% if answer and answer.answer_text %}
                            {{ answer.answer_text|linebreaks }}
                        {% else %}
                            Cevap verilmedi
                        {% endif %}
                    </div>
                    <strong>Doğru Cevap:</strong>
                    <div class="alert alert-success mt-2">
                        {{ question.correct_answer|linebreaks }}
                    </div>
                </div>
                {% endif %}
                
                {% if question.explanation %}
                <div class="alert alert-secondary mt-3">
                    <strong><i class="fas fa-lightbulb"></i> Açıklama:</strong>
                    <p class="mb-0 mt-2">{{ question.explanation|linebreaks }}</p>
                </div>
                {% endif %}
                
                {% if answer and answer.teacher_feedback %}
                <div class="alert alert-primary mt-3">
                    <strong><i class="fas fa-comment"></i> Öğretmen Geri Bildirimi:</strong>
                    <p class="mb-0 mt-2">{{ answer.teacher_feedback|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endwith %}
        {% empty %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Bu sınavda henüz soru bulunmuyor.
        </div>
        {% endfor %}
        
        <!-- Navigation -->
        <div class="d-flex justify-content-between mt-4 mb-4">
            <a href="{% url 'quiz:quiz_list_student' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Sınav Listesine Dön
            </a>
            {% if attempt.quiz.allow_review and attempt.quiz.max_attempts > attempt.attempt_number %}
            <a href="{% url 'quiz:quiz_take' attempt.quiz.id %}" class="btn btn-primary">
                <i class="fas fa-redo"></i> Tekrar Dene
            </a>
            {% endif %}
        </div>

    {% else %}
        <!-- Submission Confirmation Mode (show_results_immediately = False) -->
        <div class="card">
            <div class="card-body submission-message">
                <div class="submission-icon text-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="mb-3">Sınav Başarıyla Teslim Edildi</h2>
                <p class="lead text-muted mb-4">
                    Sınavınız başarıyla teslim edilmiştir. Öğretmen tarafından değerlendirilecektir.
                </p>
                <p class="text-muted mb-4">
                    <strong>Teslim Zamanı:</strong> {{ attempt.submitted_at|date:"d.m.Y H:i" }}
                </p>
                <a href="{% url 'quiz:quiz_list_student' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left"></i> Sınav Listesine Dön
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
