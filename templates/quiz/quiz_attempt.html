{% extends 'base.html' %}
{% load static %}

{% block title %}{{ quiz.title }} - Deneme{% endblock %}

{% block extra_css %}
<style>
#timer {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 1000;
    font-size: 24px;
    padding: 15px 25px;
}
.question-card {
    margin-bottom: 25px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Timer -->
    {% if quiz.duration_minutes > 0 %}
    <div id="timer" class="alert alert-warning">
        <i class="fas fa-clock"></i> <span id="time-remaining">{{ remaining_time }}</span>
    </div>
    {% endif %}
    
    <h2>{{ quiz.title }}</h2>
    <p class="lead">{{ quiz.description }}</p>
    
    <div class="alert alert-info">
        <strong>Deneme #{{ attempt.attempt_number }}</strong> | 
        Toplam Soru: {{ questions.count }} | 
        Süre: {% if quiz.duration_minutes > 0 %}{{ quiz.duration_minutes }} dakika{% else %}Sınırsız{% endif %}
    </div>
    
    <form method="post" id="sınav-form">
        {% csrf_token %}
        
        {% for quiz_question in questions %}
        <div class="card question-card">
            <div class="card-header bg-primary text-white">
                Soru {{ forloop.counter }} ({{ quiz_question.points }} puan)
            </div>
            <div class="card-body">
                <p><strong>{{ quiz_question.question.question_text }}</strong></p>
                
                {% if quiz_question.question.question_image %}
                <img src="{{ quiz_question.question.question_image.url }}" class="img-fluid mb-3" style="max-width: 500px;">
                {% endif %}
                
                {% if quiz_question.question.question_type == 'multiple_choice' %}
                <!-- Multiple Choice -->
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="A" id="q{{ quiz_question.id }}_a" required>
                    <label class="form-check-label" for="q{{ quiz_question.id }}_a">
                        A) {{ quiz_question.question.option_a }}
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="B" id="q{{ quiz_question.id }}_b">
                    <label class="form-check-label" for="q{{ quiz_question.id }}_b">
                        B) {{ quiz_question.question.option_b }}
                    </label>
                </div>
                {% if quiz_question.question.option_c %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="C" id="q{{ quiz_question.id }}_c">
                    <label class="form-check-label" for="q{{ quiz_question.id }}_c">
                        C) {{ quiz_question.question.option_c }}
                    </label>
                </div>
                {% endif %}
                {% if quiz_question.question.option_d %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="D" id="q{{ quiz_question.id }}_d">
                    <label class="form-check-label" for="q{{ quiz_question.id }}_d">
                        D) {{ quiz_question.question.option_d }}
                    </label>
                </div>
                {% endif %}
                {% if quiz_question.question.option_e %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="E" id="q{{ quiz_question.id }}_e">
                    <label class="form-check-label" for="q{{ quiz_question.id }}_e">
                        E) {{ quiz_question.question.option_e }}
                    </label>
                </div>
                {% endif %}
                
                {% elif quiz_question.question.question_type == 'true_false' %}
                <!-- True/False -->
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="T" id="q{{ quiz_question.id }}_t" required>
                    <label class="form-check-label" for="q{{ quiz_question.id }}_t">
                        Doğru
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_{{ quiz_question.id }}" value="F" id="q{{ quiz_question.id }}_f">
                    <label class="form-check-label" for="q{{ quiz_question.id }}_f">
                        Yanlış
                    </label>
                </div>
                
                {% elif quiz_question.question.question_type == 'short_answer' %}
                <!-- Short Answer -->
                <input type="text" class="form-control" name="question_{{ quiz_question.id }}" required>
                
                {% elif quiz_question.question.question_type == 'essay' %}
                <!-- Essay -->
                <textarea class="form-control" name="question_{{ quiz_question.id }}" rows="6" required></textarea>
                
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('Sınavı teslim etmek istediğinizden emin misiniz?')">
                <i class="fas fa-check"></i> Sınavı Teslim Et
            </button>
        </div>
    </form>
</div>

<script>
// Timer countdown
{% if quiz.duration_minutes > 0 and remaining_time %}
let remainingSeconds = {{ remaining_time }};

function updateTimer() {
    if (remainingSeconds <= 0) {
        document.getElementById('sınav-form').submit();
        return;
    }
    
    const hours = Math.floor(remainingSeconds / 3600);
    const minutes = Math.floor((remainingSeconds % 3600) / 60);
    const seconds = remainingSeconds % 60;
    
    let timeStr = '';
    if (hours > 0) timeStr += hours + ':';
    timeStr += String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    
    document.getElementById('time-remaining').textContent = timeStr;
    
    // Warning colors
    if (remainingSeconds < 300) { // 5 minutes
        document.getElementById('timer').className = 'alert alert-danger';
    } else if (remainingSeconds < 600) { // 10 minutes
        document.getElementById('timer').className = 'alert alert-warning';
    }
    
    remainingSeconds--;
}

setInterval(updateTimer, 1000);
updateTimer();
{% endif %}
</script>
{% endblock %}
