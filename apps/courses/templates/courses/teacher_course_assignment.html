{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Ders Yönetimi{% endblock %}

{% block extrastyle %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }
    .page-header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
    .page-header p { margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem; }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #667eea; }
    .stat-card .label { color: #6b7280; font-size: 0.8rem; }

    .filter-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .filter-row input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.25rem;
    }

    .course-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        overflow: hidden;
        transition: all 0.2s;
    }
    .course-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .course-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.25rem;
    }
    .course-code { font-size: 1.1rem; font-weight: 700; }
    .course-name { font-size: 0.9rem; opacity: 0.9; }

    .course-body { padding: 1rem 1.25rem; }

    .teacher-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .teacher-avatar {
        width: 40px;
        height: 40px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    .teacher-name { font-weight: 600; color: #1f2937; }
    .teacher-dept { font-size: 0.8rem; color: #6b7280; }

    .no-teacher {
        color: #92400e;
        padding: 0.75rem;
        background: #fef3c7;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
    }

    .student-count {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 1rem;
    }
    .student-count i { color: #667eea; }

    .course-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .btn-action {
        flex: 1;
        min-width: 80px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .btn-action:hover { transform: translateY(-1px); }
    .btn-assign { background: #10b981; color: white; }
    .btn-edit { background: #f59e0b; color: white; }
    .btn-remove { background: #ef4444; color: white; }
    .btn-students { background: #3b82f6; color: white; }
    .btn-add-student { background: #8b5cf6; color: white; }
    .btn-remove-student { background: #ec4899; color: white; }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay.active { display: flex; }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .modal-header h4 { margin: 0; font-weight: 700; }

    .form-group { margin-bottom: 1rem; }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    .form-group select, .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .modal-actions button {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
    }
    .btn-confirm { background: #10b981; color: white; }
    .btn-cancel { background: #f3f4f6; color: #4b5563; }

    .student-list {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
    .student-item {
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .student-item:last-child { border-bottom: none; }
    .student-item input { width: 18px; height: 18px; }
    .student-item label { flex: 1; cursor: pointer; font-size: 0.9rem; margin: 0; }

    .toast-container { position: fixed; top: 100px; right: 20px; z-index: 9999; }
    .toast {
        background: white;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        margin-bottom: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease;
    }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @media (max-width: 768px) {
        .stats-row { grid-template-columns: repeat(2, 1fr); }
        .courses-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="toast-container" id="toastContainer"></div>

<div class="page-header">
    <h1><i class="fas fa-link me-2"></i>Ders Yönetimi</h1>
    <p>Derslere öğretmen ve öğrenci atayın</p>
</div>

<div class="stats-row">
    <div class="stat-card">
        <div class="value">{{ current_assignments|length }}</div>
        <div class="label">Ders Grubu</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ teachers|length }}</div>
        <div class="label">Öğretmen</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ students|length }}</div>
        <div class="label">Öğrenci</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ courses_with_groups|length }}</div>
        <div class="label">Ders</div>
    </div>
</div>

<div class="filter-card">
    <div class="filter-row">
        <input type="text" id="searchInput" placeholder="Ders kodu veya adı ile ara..." onkeyup="filterCourses()">
    </div>
</div>

<div class="courses-grid" id="coursesGrid">
    {% for assignment in current_assignments %}
    <div class="course-card" data-code="{{ assignment.course.code }}" data-name="{{ assignment.course.name }}">
        <div class="course-header">
            <div class="course-code">{{ assignment.course.code }}</div>
            <div class="course-name">{{ assignment.course.name }}</div>
        </div>
        <div class="course-body">
            {% if assignment.teacher %}
            <div class="teacher-info">
                <div class="teacher-avatar">{{ assignment.teacher.first_name|slice:":1" }}{{ assignment.teacher.last_name|slice:":1" }}</div>
                <div>
                    <div class="teacher-name">{{ assignment.teacher.full_name }}</div>
                    <div class="teacher-dept">{{ assignment.teacher.department }}</div>
                </div>
            </div>
            {% else %}
            <div class="no-teacher">
                <i class="fas fa-exclamation-triangle me-1"></i> Öğretmen atanmamış
            </div>
            {% endif %}

            <div class="student-count">
                <i class="fas fa-users"></i>
                <span>{{ assignment.enrollments.count }} öğrenci</span>
            </div>

            <div class="course-actions">
                <button class="btn-action btn-edit" onclick="openEditModal({{ assignment.id }}, '{{ assignment.teacher.id|default_if_none:"" }}', '{{ assignment.semester|default_if_none:"" }}')">
                    <i class="fas fa-edit"></i> Düzenle
                </button>
                {% if assignment.teacher %}
                <button class="btn-action btn-remove" onclick="removeTeacher({{ assignment.id }})" title="Öğretmeni dersten çıkar">
                    <i class="fas fa-user-minus"></i> Öğretmen Çıkar
                </button>
                {% else %}
                <button class="btn-action btn-assign" onclick="openAssignModal({{ assignment.id }}, '{{ assignment.course.code }}')" title="Derse öğretmen ata">
                    <i class="fas fa-user-plus"></i> Öğretmen Ekle
                </button>
                {% endif %}
                <button class="btn-action btn-add-student" onclick="openAddStudentModal({{ assignment.id }})" title="Derse öğrenci ekle">
                    <i class="fas fa-user-graduate"></i> Öğrenci Ekle
                </button>
                <button class="btn-action btn-remove-student" onclick="openRemoveStudentModal({{ assignment.id }})" title="Dersten öğrenci çıkar">
                    <i class="fas fa-user-times"></i> Öğrenci Çıkar
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #9ca3af;">
        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
        <h4>Henüz ders grubu bulunmuyor</h4>
    </div>
    {% endfor %}
</div>


<!-- Öğretmen Atama Modal -->
<div class="modal-overlay" id="assignModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-user-plus me-2"></i>Öğretmen Ata</h4>
        </div>
        <input type="hidden" id="assignGroupId">
        <div class="form-group">
            <label>Ders</label>
            <input type="text" id="assignCourseName" readonly style="background: #f9fafb;">
        </div>
        <div class="form-group">
            <label>Öğretmen Seçin</label>
            <select id="assignTeacherId">
                <option value="">-- Öğretmen Seçin --</option>
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}">{{ teacher.full_name }} ({{ teacher.department }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Dönem</label>
            <select id="assignSemester">
                <option value="2024-2025 Güz">2024-2025 Güz</option>
                <option value="2024-2025 Bahar">2024-2025 Bahar</option>
                <option value="2025-2026 Güz">2025-2026 Güz</option>
                <option value="2025-2026 Bahar">2025-2026 Bahar</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="assignTeacher()">Ata</button>
            <button class="btn-cancel" onclick="closeModal('assignModal')">İptal</button>
        </div>
    </div>
</div>

<!-- Düzenleme Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-edit me-2"></i>Ders Grubunu Düzenle</h4>
        </div>
        <input type="hidden" id="editGroupId">
        <div class="form-group">
            <label>Öğretmen Değiştir</label>
            <select id="editTeacherId">
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}">{{ teacher.full_name }} ({{ teacher.department }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Dönem</label>
            <select id="editSemester">
                <option value="2024-2025 Güz">2024-2025 Güz</option>
                <option value="2024-2025 Bahar">2024-2025 Bahar</option>
                <option value="2025-2026 Güz">2025-2026 Güz</option>
                <option value="2025-2026 Bahar">2025-2026 Bahar</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="updateGroup()">Kaydet</button>
            <button class="btn-cancel" onclick="closeModal('editModal')">İptal</button>
        </div>
    </div>
</div>

<!-- Öğrenci Ekle Modal -->
<div class="modal-overlay" id="addStudentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-user-graduate me-2" style="color: #8b5cf6;"></i>Öğrenci Ekle</h4>
        </div>
        <input type="hidden" id="addStudentGroupId">
        <div class="form-group">
            <label>Eklenecek Öğrencileri Seçin</label>
            <input type="text" id="addStudentSearch" placeholder="Öğrenci ara..." onkeyup="filterAddStudents()" style="margin-bottom: 10px;">
            <div class="student-list" id="addStudentList">
                {% for student in students %}
                <div class="student-item" data-name="{{ student.full_name|lower }}" data-number="{{ student.school_number }}">
                    <input type="checkbox" id="add_student_{{ student.id }}" value="{{ student.id }}">
                    <label for="add_student_{{ student.id }}">{{ student.full_name }} ({{ student.school_number }})</label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="addStudents()" style="background: #8b5cf6;">Ekle</button>
            <button class="btn-cancel" onclick="closeModal('addStudentModal')">İptal</button>
        </div>
    </div>
</div>

<!-- Öğrenci Çıkar Modal -->
<div class="modal-overlay" id="removeStudentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-user-times me-2" style="color: #ec4899;"></i>Öğrenci Çıkar</h4>
        </div>
        <input type="hidden" id="removeStudentGroupId">
        <div class="form-group">
            <label>Çıkarılacak Öğrencileri Seçin</label>
            <input type="text" id="removeStudentSearch" placeholder="Öğrenci ara..." onkeyup="filterRemoveStudents()" style="margin-bottom: 10px;">
            <div class="student-list" id="removeStudentList">
                <div class="no-students" style="padding: 1rem; text-align: center; color: #9ca3af;">
                    <i class="fas fa-info-circle"></i> Kayıtlı öğrenci yok
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="removeStudents()" style="background: #ec4899;">Çıkar</button>
            <button class="btn-cancel" onclick="closeModal('removeStudentModal')">İptal</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function filterCourses() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.course-card').forEach(card => {
        const code = card.dataset.code.toLowerCase();
        const name = card.dataset.name.toLowerCase();
        card.style.display = (code.includes(search) || name.includes(search)) ? 'block' : 'none';
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openAssignModal(groupId, courseCode) {
    document.getElementById('assignGroupId').value = groupId;
    document.getElementById('assignCourseName').value = courseCode;
    document.getElementById('assignTeacherId').value = '';
    document.getElementById('assignModal').classList.add('active');
}

function assignTeacher() {
    const groupId = document.getElementById('assignGroupId').value;
    const teacherId = document.getElementById('assignTeacherId').value;
    const semester = document.getElementById('assignSemester').value;

    if (!teacherId) {
        showToast('Lütfen öğretmen seçin', 'error');
        return;
    }

    fetch('{% url "courses:update_course_group" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId, teacher_id: teacherId, semester: semester })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
    closeModal('assignModal');
}

function removeTeacher(groupId) {
    if (!confirm('Bu öğretmeni dersten çıkarmak istediğinize emin misiniz?')) return;

    fetch('{% url "courses:remove_teacher" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
}

function openEditModal(groupId, teacherId, semester) {
    document.getElementById('editGroupId').value = groupId;
    document.getElementById('editTeacherId').value = teacherId;
    document.getElementById('editSemester').value = semester || '2024-2025 Güz';
    document.getElementById('editModal').classList.add('active');
}

function updateGroup() {
    const groupId = document.getElementById('editGroupId').value;
    const teacherId = document.getElementById('editTeacherId').value;
    const semester = document.getElementById('editSemester').value;

    fetch('{% url "courses:update_course_group" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId, teacher_id: teacherId, semester: semester })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
    closeModal('editModal');
}

function openStudentModal(groupId) {
    document.getElementById('studentGroupId').value = groupId;
    document.querySelectorAll('#studentList input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    fetch(`/courses/teacher-assignment/bulk-enroll-students/?group_id=${groupId}`)
        .then(r => r.json())
        .then(data => {
            if (data.enrolled_students) {
                data.enrolled_students.forEach(id => {
                    const cb = document.getElementById(`student_${id}`);
                    if (cb) cb.checked = true;
                });
            }
        }).catch(() => {});
    
    document.getElementById('studentModal').classList.add('active');
}

function saveStudents() {
    const groupId = document.getElementById('studentGroupId').value;
    const selectedIds = [];
    document.querySelectorAll('#studentList input[type="checkbox"]:checked').forEach(cb => {
        selectedIds.push(parseInt(cb.value));
    });

    fetch('{% url "courses:bulk_enroll_students" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId, student_ids: selectedIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
    closeModal('studentModal');
}

// Öğrenci Ekle Modal
function openAddStudentModal(groupId) {
    document.getElementById('addStudentGroupId').value = groupId;
    document.querySelectorAll('#addStudentList input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('addStudentSearch').value = '';
    
    // Mevcut kayıtlı öğrencileri al ve onları gizle
    fetch(`/courses/teacher-assignment/bulk-enroll-students/?group_id=${groupId}`)
        .then(r => r.json())
        .then(data => {
            const enrolledIds = data.enrolled_students || [];
            document.querySelectorAll('#addStudentList .student-item').forEach(item => {
                const cb = item.querySelector('input[type="checkbox"]');
                if (enrolledIds.includes(parseInt(cb.value))) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            });
        }).catch(() => {
            document.querySelectorAll('#addStudentList .student-item').forEach(item => {
                item.style.display = 'flex';
            });
        });
    
    document.getElementById('addStudentModal').classList.add('active');
}

function filterAddStudents() {
    const search = document.getElementById('addStudentSearch').value.toLowerCase();
    document.querySelectorAll('#addStudentList .student-item').forEach(item => {
        if (item.style.display === 'none') return;
        const name = item.dataset.name || '';
        const number = item.dataset.number || '';
        item.style.display = (name.includes(search) || number.includes(search)) ? 'flex' : 'none';
    });
}

function addStudents() {
    const groupId = document.getElementById('addStudentGroupId').value;
    const selectedIds = [];
    document.querySelectorAll('#addStudentList input[type="checkbox"]:checked').forEach(cb => {
        selectedIds.push(parseInt(cb.value));
    });

    if (selectedIds.length === 0) {
        showToast('Lütfen en az bir öğrenci seçin', 'error');
        return;
    }

    fetch('{% url "courses:bulk_enroll_students" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId, student_ids: selectedIds, action: 'add' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || selectedIds.length + ' öğrenci eklendi');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
    closeModal('addStudentModal');
}

// Öğrenci Çıkar Modal
function openRemoveStudentModal(groupId) {
    document.getElementById('removeStudentGroupId').value = groupId;
    document.getElementById('removeStudentSearch').value = '';
    const listContainer = document.getElementById('removeStudentList');
    
    listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af;"><i class="fas fa-spinner fa-spin"></i> Yükleniyor...</div>';
    
    fetch(`/courses/teacher-assignment/bulk-enroll-students/?group_id=${groupId}`)
        .then(r => r.json())
        .then(data => {
            const enrolledIds = data.enrolled_students || [];
            const enrolledStudents = data.enrolled_student_details || [];
            
            if (enrolledIds.length === 0) {
                listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af;"><i class="fas fa-info-circle"></i> Bu derste kayıtlı öğrenci yok</div>';
            } else {
                let html = '';
                enrolledStudents.forEach(student => {
                    html += `<div class="student-item" data-name="${student.name.toLowerCase()}" data-number="${student.school_number}">
                        <input type="checkbox" id="remove_student_${student.id}" value="${student.id}">
                        <label for="remove_student_${student.id}">${student.name} (${student.school_number})</label>
                    </div>`;
                });
                listContainer.innerHTML = html || '<div style="padding: 1rem; text-align: center; color: #9ca3af;"><i class="fas fa-info-circle"></i> Bu derste kayıtlı öğrenci yok</div>';
            }
        }).catch(() => {
            listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-circle"></i> Öğrenciler yüklenemedi</div>';
        });
    
    document.getElementById('removeStudentModal').classList.add('active');
}

function filterRemoveStudents() {
    const search = document.getElementById('removeStudentSearch').value.toLowerCase();
    document.querySelectorAll('#removeStudentList .student-item').forEach(item => {
        const name = item.dataset.name || '';
        const number = item.dataset.number || '';
        item.style.display = (name.includes(search) || number.includes(search)) ? 'flex' : 'none';
    });
}

function removeStudents() {
    const groupId = document.getElementById('removeStudentGroupId').value;
    const selectedIds = [];
    document.querySelectorAll('#removeStudentList input[type="checkbox"]:checked').forEach(cb => {
        selectedIds.push(parseInt(cb.value));
    });

    if (selectedIds.length === 0) {
        showToast('Lütfen en az bir öğrenci seçin', 'error');
        return;
    }

    if (!confirm(selectedIds.length + ' öğrenciyi bu dersten çıkarmak istediğinize emin misiniz?')) return;

    fetch('{% url "courses:bulk_unenroll_students" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ group_id: groupId, student_ids: selectedIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || selectedIds.length + ' öğrenci çıkarıldı');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    });
    closeModal('removeStudentModal');
}

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
    });
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    }
});
</script>
{% endblock %}
